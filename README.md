
# FaceVerify

This project contains Datachecker's FaceVerify tool, that captures images of faces to be used in liveness detection. The tool only takes a capture once the trigger mechanism is fired.

To perform liveness detection, two slightly different images of the same person are required. For example, when a person moves his/her head slightly this will generate a different image. Therefore, the tool checks difference in movement between frames.

The tool features user challenge-response, namely head pose estimation, in order to prevent video injection attacks.

The tool will be run in the browser and is therefore written in JavaScript.

## Trigger mechanism

The tool performs the following checks:

- Is the environment not too dark (under exposure)?
- Is there a face?
- Is the face occluded?
- Is the detected face not too far?
- Is the detected face not too close?
- Is the face centered?
- Is the image sharp?
- Is there movement?

The movement check will only be used for the second picture. Since the first picture has no other picture to compare to.

## Prerequisites

Please visit [Datachecker API documentation](https://developer.datachecker.nl/).

- Datachecker [OAuth Token](#oauth-token)
- Datachecker [SDK Token](#sdk-token)

# OAuth Token

Datachecker uses OAuth authorization. In order to request the [SDK token](#sdk-token) you will need to provide a valid OAuth token in the header.

Example header:

```javascript
header = {'Authorization': `Bearer ${response.accessToken}`}
```

This OAuth token can be retrieved with the [Datachecker OAuth Token API](https://developer.datachecker.nl/?urls.primaryName=v2#/ProductApi/ProductApi_OAuthToken). The scope `"productapi.sdk.read"` needs to be present to make use of the [SDK token](#sdk-token). If this scope is missing you will not be able to retrieve an SDK token.

FaceVerify also requires the other following scopes to send and receive results: `"productapi.faceverify.write", "productapi.poll.read", "productapi.result.read"`

Example OAuth:

```javascript
fetch(<BASE_ENDPOINT>+"/oauth/token", {
    method: 'POST',
    body: JSON.stringify({
        "clientId": <CLIENTID>,
        "clientSecret": <CLIENTSECRET>,
        "scopes": [
            "productapi.sdk.read",
            "productapi.faceverify.write",
            "productapi.poll.read",
            "productapi.result.read",
        ]
    })
})
.then(response => response.json())
```

Note: Contact Datachecker for *client_id* and *client_secret*.

# SDK Token

The SDK is locked. In order to use the SDK in production a *token* is required. The application can only be started with a valid token. This token is a `base64` string. The token can be generated by calling the [Datachecker SDK Token API](https://developer.datachecker.nl/?urls.primaryName=v2#/ProductApi/ProductApi_SdkToken).

Example:

```javascript
fetch(<BASE_ENDPOINT>+"/sdk/token?number_of_challenges=2&customer_reference=<CUSTOMER>&validateWatermark=true&services=FACE_VERIFY", {
    method: 'GET',
    headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Authorization': `Bearer <ACCESSTOKEN>`
    }
})
.then(response => response.json())
```

## Steps

1. Request OAUTH Token
2. Put OAuth in header
3. SDK configuration (add SDK token)
4. Run SDK

## Configuration

To run this tool, you will need initialise with the following variables.

| **ATTRIBUTE**          | **FORMAT**          | **DEFAULT VALUE**                      | **EXAMPLE**                               | **NOTES**                                                                                                                                              |
| ---------------------- | ------------------- | -------------------------------------- | ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `BACKEND`              | string              | `wasm`                                 | `wasm`                                    | **optional**<br> Neural network execution provider. Possible values: [`wasm`, `webgl`, `cpu`]. `wasm` is recommended whereas `cpu` is not recommended. |
| `CAPTURE_WAITING_TIME` | int                 | `0`                                    | `500`                                     | **optional**<br> Waiting time between capturing in milliseconds.                                                                                       |
| `CHALLENGES`           | array               |                                        | `['up', 'right', 'down', 'left', 'up']`   | **optional**<br> Array of `challenges` that can be used for Demo purposes.                                                                             |
| `CONTAINER_ID`         | string              |                                        | `"FV_mount"`                              | **required**<br> _div id_ to mount tool on.                                                                                                            |
| `COUNTDOWN_MAX`        | int                 | `0`                                    | `500`                                     | **optional**<br> If `COUNTDOWN == 0` then countdown will be a random between `COUNTDOWN_MIN` and `COUNTDOWN_MAX`.                                      |
| `COUNTDOWN_MIN`        | int                 | `0`                                    | `0`                                       | **optional**<br> If `COUNTDOWN == 0` then countdown will be a random between `COUNTDOWN_MIN` and `COUNTDOWN_MAX`.                                      |
| `COUNTDOWN`            | int                 | `0`                                    | `3000`                                    | **optional**<br> Countdown in ms before picture is taken.                                                                                              |
| `DEBUG`                | bool                | `false`                                | `false`                                   | **optional**<br> When debug is `true` more detailed logs will be visible.                                                                              |
| `DOWN_THRESHOLD`       | int                 | `30`                                   | `30`                                      | **optional**<br> Challenge `down` threshold value.                                                                                                     |
| `LANGUAGE`             | string              | `"nl"`                                 | `"nl"`                                    | **required**<br> Notifications in specific language.                                                                                                   |
| `LEFT_THRESHOLD`       | int                 | `22`                                   | `22`                                      | **optional**<br> Challenge `left` threshold value.                                                                                                     |
| `MODELS_PATH`          | string              | `"models/"`                            | `"models/"`                               | **optional**<br> Path referring to models location.                                                                                                    |
| `MOVEMENT_THRESHOLD`   | int                 | `20`                                   | `20`                                      | **optional**<br> Movement will be calculated from frame to frame with a value between 0-100. Recommended value between 20 and 30.                      |
| `RIGHT_THRESHOLD`      | int                 | `22`                                   | `22`                                      | **optional**<br> Challenge `right` threshold value.                                                                                                    |
| `ROOT`                 | string              | `""`                                   | `"../"`                                   | **optional**<br> Root location.                                                                                                                        |
| `STOP_AFTER`           | int                 |                                        | `10000`                                   | **optional**<br> Stopping timer in ms.                                                                                                                 |
| `TOKEN`                | string              |                                        | see [SDK Token](#sdk-token)               | **required**<br> Datachecker SDK token.                                                                                                                |
| `UP_THRESHOLD`         | int                 | `35`                                   | `35`                                      | **optional**<br> Challenge `up` threshold value.                                                                                                       |
| `onComplete`           | javascript function |                                        | `function(data) {console.log(data)}`      | **required**<br> Callback function on _complete_ .                                                                                                     |
| `onError`              | javascript function | `function(error) {console.log(error)}` | `function(error) {console.log(error)}`    | **required**<br> Callback function on _error_.                                                                                                         |
| `onUserExit`           | javascript function | `function(error) {console.log(error)}` | `function(error) {window.history.back()}` | **required**<br> Callback function on _user exit_.                                                                                                     |

## Handling callbacks

Within the application, you can take advantage of three callback functions to enhance the user experience and manage the flow of your process.

Note: When integrating the application into Native Apps using web views, it's essential to adapt and utilize these callback functions according to the conventions and requirements of the native platforms (e.g., iOS, Android). Native app development environments may have specific ways of handling JavaScript callbacks, and you should ensure seamless communication between the web view and the native code.

Example Web (JS):

```javascript
let FV = new FaceVerify();
FV.init({
    CONTAINER_ID: 'FV_mount',
    LANGUAGE: 'en',
    TOKEN: '<SDK_TOKEN>',
    onComplete: function(data) {
        console.log(data);
    },
    onError: function(error) {
        console.log(error)
    },
    onUserExit: function(error) {
        console.log(error);
        window.history.back()
    }
});
```

| **ATTRIBUTE** | **FORMAT**          | **DEFAULT VALUE**                      | **EXAMPLE**                               | **NOTES**                                                                                            |
| ------------- | ------------------- | -------------------------------------- | ----------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| `onComplete`  | javascript function |                                        | `function(data) {console.log(data)}`      | **required**<br> Callback that fires when all interactive tasks in the workflow have been completed. |
| `onError`     | javascript function | `function(error) {console.log(error)}` | `function(error) {console.log(error)}`    | **required**<br> Callback that fires when an _error_ occurs.                                         |
| `onUserExit`  | javascript function | `function(error) {console.log(error)}` | `function(error) {window.history.back()}` | **required**<br> Callback that fires when the user exits the flow without completing it.             |

### onComplete

This callback function will be called once all the tasks within the workflow succesfully have been completed. This callback function is **required**. The `data` parameter within the function represents the [output](#output) of the completed process. You can customize this function to handle and display the data as needed.

Example Web (JS):

Within the example below we are logging the output (`data`) to console.

```javascript
let FV = new FaceVerify();
FV.init({
    ...,
    onComplete: function(data) {
        console.log(data);
        FV.stop();
    }
});
```

### onError

This callback can be used to alert users when something goes wrong during the process. This callback function is **required**. The `error` parameter within the function contains information about the specific error encountered, allowing you to log or display error messages for debugging or user guidance. The errors that are thrown are either known or unknown. The known errors can be found within the [Languages](#languages) dictionary. On the other hand, the unknown errors will be thrown as is.  

Example Web (JS):

Within the example below we are logging the output (`error`) to console.

```javascript
let FV = new FaceVerify();
FV.init({
    ...,
    onError: function(error) {
        console.log(error)
    }
});
```

### onUserExit

This callback can be used to implement actions like returning users to the previous page or prompting them for confirmation before exiting to ensure they don't lose any unsaved data or work. This callback function is **required**. The `error` parameter within the function contains information about the specific error encountered, allowing you to log or display error messages for debugging or user guidance. The error that is thrown is `"exit"`.

Example Web (JS):

Within the example below we are logging the output (`error`) to console. Finally, we move back one page in the session history with `window.history.back()`.

```javascript
let FV = new FaceVerify();
FV.init({
    ...,
    onUserExit: function(error) {
        console.log(error);
        window.history.back()
    }
});
```

## Usage/Examples

The tool first needs to be initialised to load all the models.
Once its initialised, it can be started with the function `FV.start();`

```javascript
let FV = new FaceVerify();
FV.init({
    CONTAINER_ID: ...,
    LANGUAGE: ...,
    TOKEN: ...,
    onComplete: ...,
    onError: ...,
    onUserExit: ...,
}).then(() => {
    FV.start();
});
```

To stop the camera and delete the container with its contents the `stop` function can be called. This function will automatically be called within `onComplete`, `onError` and `onUserExit` thus do not have to be called within your own custom versions of these functions.

```javascript
...
FV.stop();
```

Example below:

```javascript
let FV = new FaceVerify();
FV.init({
    CONTAINER_ID: 'FV_mount',
    LANGUAGE: 'nl',
    TOKEN: '<SDK_TOKEN>',
    onComplete: function(data) {
        console.log(data);
    },
    onError: function(error) {
        console.log(error)
    },
    onUserExit: function(error) {
        console.log(error);
        window.history.back();
    },
});
```

## Requirements

CSS stylesheet.

```html
<link href="css/faceverify.css" rel="stylesheet" type="text/css" />
```

The meta tags below are required to view the tool properly.

```html
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
```

Load script.

```js
<script src="js/faceverify.obf.js" type="text/javascript"></script>
```

## Demo

File present under `html/index.html`

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>FaceVerify</title>
<link href="css/faceverify.css" rel="stylesheet" type="text/css" />
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
</head>

<body>
    <div id="FV_mount" style="height:100vh">
    </div>
</body>

<script src="js/faceverify.obf.js" type="text/javascript"></script>
<script>
    let FV = new FaceVerify();
    FV.init({
        CONTAINER_ID: 'FV_mount',
        LANGUAGE: 'en',
        TOKEN: '<SDK_TOKEN>',
        onComplete: function(data) {
            console.log(data)
        },
        onError: function(error) {
            console.log(error)
        },
        onUserExit: function(error) {
            console.log(error);
            window.history.back();
        },
    });    
</script>

</html>
```

## Languages

The languages can be found in `js/language/`. The current support languages are `en` and `nl`. More languages could be created.

The notifications can be loaded in `configuration` like the following:

```javascript
let FV = new FaceVerify();
FV.init({
    LANGUAGE: 'en',
    ...
```

To create support for a new language, a js file needs to be created with specific keys.
The keys can be derived from the current language js files (`js/language/en.js`).

Example:

```javascript
var LANGUAGE = {
    "start_prompt": "Tap to start.",
    "no_face": "No face detected,\nplease position your face in the frame.",
    "nod_head": "Please nod your head slightly.",
    "face_thresh": "Face not clearly visible.\nEnsure better lighting conditions\nor make sure your face is not covered.",
    "face_far": "Please move closer to the camera.",
    "face_close": "Face too close,\nplease move slightly away.",
    "exp_dark": "The image is too dark.\nFind a well-lit environment.",
    "exp_light": "The image is too light.\nFind a dimmer environment.",
    "blur": "Image is not sharp,\nplease stay still.",
    "capture_error": "We could not capture an image.\nAccess to the camera is required.",
    "challenge_0": "Slowly move your face to the center.",
    "challenge_out": "Watch out, your face is too far in the specified direction.\nMove slightly back.",
    "challenge_1": "Slowly move your face up\nand hold still.",
    "challenge_12": "Watch out, you are looking diagonally upwards.\nSlowly move your face upwards and hold still.",
    "challenge_14": "Watch out, you are looking diagonally upwards.\nSlowly move your face upwards and hold still.",
    "challenge_2": "Slowly move your face to the right\nand hold still.",
    "challenge_21": "Watch out, you are looking diagonally upwards.\nSlowly move your face to the right and hold still.",
    "challenge_23": "Watch out, you are looking diagonally downwards.\nSlowly move your face to the right and hold still.",
    "challenge_3": "Slowly move your face down\nand hold still.",
    "challenge_32": "Watch out, you are looking diagonally downwards.\nSlowly move your face downwards and hold still.",
    "challenge_34": "Watch out, you are looking diagonally downwards.\nSlowly move your face downwards and hold still.",
    "challenge_4": "Slowly move your face to the left\nand hold still.",
    "challenge_41": "Watch out, you are looking diagonally upwards.\nSlowly move your face to the left and hold still.",
    "challenge_43": "Watch out, you are looking diagonally downwards.\nSlowly move your face to the left and hold still."
}
```

## Models

The tool uses a collection of neural networks. Make sure that you host the full directory so the models can be accessed. The models path can be configured. (see [Configuration](#configuration))
The models are located under `models/`. Model cards can also be found in this directory.

## Challenges

User challenges are implemented, in order to prevent video injection attacks. These challenges are randomly chosen and thereby, processes are different from one another. The challenges consist of *head pose estimation*. The performed head poses with be compared with the challenges and that result will be returned as bool in `output`. (see [Output](#output))

There are four poses that will be detected:

- up
- right
- down
- left

Challenges are embedded in the `TOKEN`. Therefore, the challenges are not directly visible.

```javascript
let FV = new FaceVerify();
FV.init({
    CONTAINER_ID: 'FV_mount',
    LANGUAGE: 'nl',
    TOKEN: "<SDK_TOKEN>",
    ...
```

## Output

The SDK will output in the following structure:

```json
{   
    "images": [{"data":"<BASE64_IMG>", "type":"LIVE"}, "..."],
    "meta": [{"x":"", "y":"", "width":"", "height":""}, "..."],
    "token": "<SDK_TOKEN>",
    "transactionId": "<TRANSACTION_ID>",
    "valid_challenges": "true|false"
}
```

Example:

```json
{   
    "images": [{"data":"/9j/4AAQSkZJRgABAQAAAQABAAD/...", "type":"LIVE"}, {"data":"/9j/4AAQSkZJRgABAQAAAQABAAD/...", "type":"LIVE"}, {"data":"/9j/4AAQSkZJRgABAQAAAQABAAD/...", "type":"LIVE"}],
    "meta": [{"x": 33, "y": 182, "width": 265, "height": 354}, {"x": 33, "y": 182, "width": 265, "height": 354}, {"x": 33, "y": 182, "width": 265, "height": 354}],
    "token": "<SDK_TOKEN>",
    "transactionId": "<TRANSACTION_ID>",
    "valid_challenges": true
}
```

### FaceVerify API call

If you want to send the images to the [Datachecker FaceVerify API](https://developer.datachecker.nl/?urls.primaryName=v2#/ProductApi/ProductApi_FaceVerify) you **must** add a *comparison image*. This *comparison image* can either be a portrait picture from an identity card or a selfie. To add this image, you need to use `type: "COMPARE"`.

Example JS:

```javascript
let faceverify_output = {   
    "images": [{"data":"/9j/4AAQSkZJRgABAQAAAQABAAD/...", "type":"LIVE"}, {"data":"/9j/4AAQSkZJRgABAQAAAQABAAD/...", "type":"LIVE"}, {"data":"/9j/4AAQSkZJRgABAQAAAQABAAD/...", "type":"LIVE"}],
    "meta": [{"x": 33, "y": 182, "width": 265, "height": 354}, {"x": 33, "y": 182, "width": 265, "height": 354}, {"x": 33, "y": 182, "width": 265, "height": 354}],
    "token": "<SDK_TOKEN>",
    "transactionId": "<TRANSACTION_ID>",
    "valid_challenges": true
}
let images = faceverify_output.images
let portrait_image = {"data":"/9j/4AAQSkZJRgABAQAAAQABAAD/...", "type":"COMPARE"}

images.unshift(portrait_image)
let data = {"images": images, "transaction_id":faceverify_output.transactionId}


fetch(<BASE_ENDPOINT>+"/faceverify", {
        method: 'POST',
        headers: <HEADERS>,
        body: JSON.stringify(data)
        })
        .then(response => response.json())
```
